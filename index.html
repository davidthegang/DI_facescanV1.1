<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ប្រព័ន្ធស្កេនមុខឌីជីថល</title>
    <link rel="icon" href="https://img.freepik.com/premium-vector/face-scan-icon_933463-79729.jpg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Moul&display=swap');
        body {
            font-family: 'Kantumruy Pro', sans-serif; background: #0f172a;
            min-height: 100vh; display: flex; justify-content: center; align-items: center; color: #e2e8f0;
        }
        .main-card {
            background: rgba(30, 41, 59, 0.7); border-radius: 24px; border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .video-container { 
            position: relative; border-radius: 50%; overflow: hidden; border: 5px solid transparent; 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .video-container.ready { border-color: #4ade80; box-shadow: 0 0 25px rgba(74, 222, 128, 0.6); }
        .scanner-line {
            position: absolute; left: 0; width: 100%; height: 3px;
            background: linear-gradient(to right, transparent, #4ade80, transparent);
            box-shadow: 0 0 10px #4ade80; animation: scan 3s linear infinite;
            opacity: 0; transition: opacity 0.3s;
        }
        .video-container.ready .scanner-line { opacity: 1; }
        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        .choices { margin-bottom: 0; }
        .choices__inner { 
            background-color: #1e293b; border: 1px solid #475569; border-radius: 12px;
            padding: 10px 15px; font-size: 1rem; color: #e2e8f0; 
        }
        .choices__list--dropdown { background-color: #1e293b; border-color: #475569; border-radius: 12px; }
        .choices__item--choice { color: #e2e8f0; }
        .choices__item--choice.is-highlighted { background-color: #334155; }
        .choices__placeholder { color: #94a3b8; }
        .modal { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; border: 1px solid #475569; }
        .khmer-title { font-family: "Moul", serif; }

        /* --- HIGHLIGHT DESIGN (RED) --- */
        /* Style for items in the DROPDOWN list */
        .choices__item--choice.has-uploaded {
            background-color: rgba(220, 38, 38, 0.1);      /* Subtle red background */
            border-left: 4px solid #dc2626;               /* Red left border indicator */
            color: #f87171;                              /* Brighter red text */
            font-weight: 600;
        }
        /* Style for uploaded items in dropdown WHEN HOVERED */
        .choices__list--dropdown .choices__item--choice.has-uploaded.is-highlighted {
            background-color: rgba(220, 38, 38, 0.25);     /* Darker red on hover */
            color: #ef4444;                               /* Even brighter red text on hover */
        }
        /* Style for the SELECTED item in the input field */
        .choices__inner .choices__item.has-uploaded-selected {
            background-color: #991b1b;                     /* A solid, dark red background */
            border: 1px solid #ef4444;                     /* Red border */
            color: #ffffff;                                /* White text for contrast */
            border-radius: 8px;
        }
    </style>
</head>

<body class="bg-slate-900">
    <div id="loading-state" class="fixed inset-0 flex flex-col items-center justify-center bg-slate-900 z-50 transition-opacity duration-500">
        <img src="di_logo.png" alt="Logo" class="w-24 h-24 rounded-full mb-4 shadow-lg">
        <p class="text-slate-300 text-lg">កំពុងទាញយកទិន្នន័យ...</p>
    </div>

    <div class="container w-full max-w-md p-6 main-card relative">
        <button id="back-btn" class="hidden absolute top-16 left-4 w-10 h-10 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition transform hover:scale-110 z-20" title="Back to Selection">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
        </button>
        <h1 class="text-center text-2xl mb-2 text-white khmer-title">ប្រព័ន្ធស្កេនមុខឌីជីថល</h1>
        <p id="subtitle" class="text-center text-slate-200 mb-6">សូមជ្រើសរើសអត្តលេខរបស់អ្នក</p>
        <div id="selection-area" class="mb-5"><select id="student-select"></select></div>
        <div id="camera-section" class="hidden flex flex-col items-center space-y-4">
            <div id="video-wrapper" class="video-container w-full max-w-sm mx-auto aspect-square">
                <video id="video" autoplay muted playsinline></video>
                <div class="scanner-line"></div>
            </div>
            <button id="switch-camera-btn" class="hidden w-14 h-14 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition transform hover:scale-110" title="Switch Camera">
                <i class="fa-solid fa-camera-rotate text-2xl"></i>
            </button>
            <canvas id="capture-canvas" class="hidden"></canvas>
            <img id="photo-preview" class="hidden w-full max-w-sm mx-auto aspect-square rounded-full border-4 border-green-400 object-cover shadow-lg">
            <p id="face-status" class="text-center text-sm h-5 font-semibold text-slate-400"></p>
            <div class="flex flex-col w-full space-y-3">
                <button id="upload-btn" class="hidden w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-semibold hover:opacity-90 transition shadow-lg">បញ្ជូនរូបភាព</button>
                <button id="retake-btn" class="hidden w-full bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition">ថតម្តងទៀត</button>
            </div>
        </div>
    </div>
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
      <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center">
        <div id="modal-icon" class="w-16 h-16 mx-auto mb-4"></div>
        <p id="modal-message" class="text-lg font-semibold text-white mb-6"></p>
        <button id="modal-close-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">យល់ព្រម</button>
      </div>
    </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz53cMjgR7YKmKpcHsDr525b2TYUUfVu9cWUhUafEUnymH4uPjsRABuELDnia84-aHm/exec';
    const studentSelect = document.getElementById('student-select'), video = document.getElementById('video'),
        captureCanvas = document.getElementById('capture-canvas'), photoPreview = document.getElementById('photo-preview'),
        uploadBtn = document.getElementById('upload-btn'), retakeBtn = document.getElementById('retake-btn'),
        cameraSection = document.getElementById('camera-section'), videoWrapper = document.getElementById('video-wrapper'),
        faceStatus = document.getElementById('face-status'), subtitle = document.getElementById('subtitle'),
        loadingState = document.getElementById('loading-state'), switchCameraBtn = document.getElementById('switch-camera-btn'),
        backBtn = document.getElementById('back-btn'), modal = document.getElementById('modal'),
        modalIcon = document.getElementById('modal-icon'), modalMessage = document.getElementById('modal-message'),
        modalCloseBtn = document.getElementById('modal-close-btn');
    const icons = {
        success: `<svg class="w-full h-full text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        error: `<svg class="w-full h-full text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        loading: `<div class="w-16 h-16 border-4 border-slate-500 border-t-indigo-500 rounded-full animate-spin"></div>`
    };
    let studentsData = [], currentStream, faceApiInterval, stableFrames = 0, choicesInstance, currentFacingMode = 'user';
    function showModal(type, message) {
        modalIcon.innerHTML = icons[type]; modalMessage.textContent = message; modal.classList.remove('hidden');
        modalCloseBtn.classList.toggle('hidden', type === 'loading');
    }
    modalCloseBtn.onclick = () => modal.classList.add('hidden');
    function initChoices() {
        choicesInstance = new Choices(studentSelect, {
            searchEnabled: true, placeholder: true, placeholderValue: 'សូមជ្រើស ID ឬឈ្មោះ...',
            noResultsText: 'រកមិនឃើញទិន្នន័យ', itemSelectText: '', searchPlaceholderValue: 'ស្វែងរក...',
            callbackOnCreateTemplates: function (template) {
                return {
                    item: (classNames, data) => {
                        let newClassNames = `${classNames.item}`;
                        if (data.customProperties && data.customProperties.hasUploaded) {
                            newClassNames += ' has-uploaded-selected';
                        }
                        return template(`<div class="${newClassNames}" data-item data-id="${data.id}" data-value="${data.value}">${data.label}</div>`);
                    },
                    choice: (classNames, data) => {
                        let newClassNames = `${classNames.item} ${classNames.choice}`;
                        if (data.customProperties && data.customProperties.hasUploaded) {
                            newClassNames += ' has-uploaded';
                        }
                        return template(`<div class="${newClassNames}" data-select-text="${this.config.itemSelectText}" data-choice data-id="${data.id}" data-value="${data.value}" ${data.disabled ? 'data-choice-disabled aria-disabled="true"' : 'data-choice-selectable'} id="${data.elementId}">${data.label}</div>`);
                    },
                };
            },
        });
    }
    async function loadModels() {
        const MODEL_URL = './weights';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
            faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
        ]);
    }
    async function fetchStudents() {
        try {
            const res = await fetch(SCRIPT_URL); const data = await res.json();
            studentsData = data.slice(1);
            const options = studentsData.map(student => ({
                value: student[0], label: `${student[0]} - ${student[1]}`,
                customProperties: { hasUploaded: student[3] }
            }));
            choicesInstance.setChoices(options, 'value', 'label', true);
        } catch (e) { showModal('error', 'មិនអាចទាញយកទិន្នន័យសិស្សបានទេ។'); }
    }
    async function startCamera(facingMode = 'user') {
        currentFacingMode = facingMode; subtitle.textContent = "កំពុងបើកកាមេរ៉ា...";
        cameraSection.classList.remove('hidden'); document.getElementById('selection-area').classList.add('hidden');
        switchCameraBtn.classList.remove('hidden'); backBtn.classList.remove('hidden'); stopCamera();
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode, width: 640, height: 480 } });
            currentStream = stream; video.srcObject = stream;
            video.onloadedmetadata = () => { subtitle.textContent = "សូមដាក់មុខរបស់អ្នកឱ្យចំកណ្តាល"; detectFace(); };
        } catch (err) { showModal('error', 'សូមអនុញ្ញាតឱ្យប្រើកាមេរ៉ា'); resetToSelection(); }
    }
    async function detectFace() {
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
        clearInterval(faceApiInterval);
        faceApiInterval = setInterval(async () => {
            const result = await faceapi.detectSingleFace(video, options).withFaceExpressions();
            if (result && result.detection.score > 0.8) {
                stableFrames++; faceStatus.textContent = `ល្អណាស់! (${stableFrames}/4)`;
                faceStatus.classList.remove('text-slate-400'); faceStatus.classList.add('text-green-400');
                videoWrapper.classList.add('ready');
                if (stableFrames >= 4) captureFace();
            } else {
                stableFrames = 0; faceStatus.textContent = "សូមដាក់មុខចំកណ្តាលកាមេរ៉ា";
                faceStatus.classList.remove('text-green-400'); faceStatus.classList.add('text-slate-400');
                videoWrapper.classList.remove('ready');
            }
        }, 400);
    }
    function captureFace() {
        clearInterval(faceApiInterval); const ctx = captureCanvas.getContext('2d');
        const size = 512; captureCanvas.width = size; captureCanvas.height = size;
        ctx.translate(size, 0); ctx.scale(-1, 1);
        let sx, sy, sWidth, sHeight;
        const videoRatio = video.videoWidth / video.videoHeight;
        if (videoRatio > 1) { sHeight = video.videoHeight; sWidth = sHeight; sx = (video.videoWidth - sWidth) / 2; sy = 0; } 
        else { sWidth = video.videoWidth; sHeight = sWidth; sx = 0; sy = (video.videoHeight - sHeight) / 2; }
        ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, size, size);
        photoPreview.src = captureCanvas.toDataURL('image/jpeg', 0.9); stopCamera();
        switchCameraBtn.classList.add('hidden'); videoWrapper.classList.add('hidden');
        photoPreview.classList.remove('hidden'); uploadBtn.classList.remove('hidden'); retakeBtn.classList.remove('hidden');
        faceStatus.classList.add('hidden'); subtitle.textContent = "សូមបញ្ជាក់រូបភាពរបស់អ្នក";
    }
    function stopCamera() { if (currentStream) currentStream.getTracks().forEach(t => t.stop()); clearInterval(faceApiInterval); }
    function resetToSelection() {
        stopCamera(); cameraSection.classList.add('hidden'); switchCameraBtn.classList.add('hidden');
        backBtn.classList.add('hidden'); photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden');
        retakeBtn.classList.add('hidden'); videoWrapper.classList.remove('hidden');
        document.getElementById('selection-area').classList.remove('hidden'); subtitle.textContent = "សូមជ្រើសរើសអត្តលេខរបស់អ្នក";
        choicesInstance.clearStore(); fetchStudents();
    }
    uploadBtn.onclick = async () => {
        const id = choicesInstance.getValue(true);
        if (!id) {
          showModal('error', 'Please select a student first.');
          return;
        }
        const s = studentsData.find(x => x[0] == id);
         if (!s) {
          showModal('error', 'Could not find student data. Please go back and select again.');
          return;
        }
        const imageData = captureCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
        showModal('loading', 'កំពុងបញ្ជូន...');
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST', body: JSON.stringify({ id: s[0], name: s[1], studentClass: s[2], imageData }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const r = await res.json();
            if (r.status === 'success') { showModal('success', "បញ្ជូនជោគជ័យ!"); modalCloseBtn.onclick = () => location.reload(); } 
            else throw new Error(r.message);
        } catch (e) { showModal('error', `មានបញ្ហាក្នុងការបញ្ជូនរូបភាព: ${e.message}`); }
    };
    retakeBtn.onclick = async () => {
        photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden');
        videoWrapper.classList.remove('hidden'); faceStatus.classList.remove('hidden'); switchCameraBtn.classList.remove('hidden');
        backBtn.classList.remove('hidden'); stableFrames = 0; startCamera(currentFacingMode);
    };
    switchCameraBtn.onclick = () => { const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user'; startCamera(newFacingMode); };
    backBtn.onclick = () => { resetToSelection(); };
    document.addEventListener("visibilitychange", () => { if (document.hidden) stopCamera(); });
    window.onload = async () => {
        initChoices(); await loadModels(); await fetchStudents();
        loadingState.style.display = 'none';
        studentSelect.addEventListener('change', async e => { if (e.detail.value) await startCamera('user'); });
    };
  </script>
</body>
</html>
