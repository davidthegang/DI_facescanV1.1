<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Face Scan Digital Industry</title>
  <link rel="icon" href="https://img.freepik.com/premium-vector/face-scan-icon_933463-79729.jpg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" defer></script>

  <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Kantumruy Pro', sans-serif;
      background: linear-gradient(to top, #accbee 0%, #e7f0fd 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    video, canvas { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    .video-container { position: relative; border-radius: 50%; overflow: hidden; border: 5px solid #e5e7eb; transition: .3s; }
    .video-container.ready { border-color: #22c55e; box-shadow: 0 0 20px rgba(34,197,94,0.5); }
    .loader {
      border: 3px solid #fff; border-top: 3px solid #6b21a8; border-radius: 50%;
      width: 20px; height: 20px; animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-gray-100">
  <div id="loading-state" class="fixed inset-0 flex flex-col items-center justify-center bg-black bg-opacity-60 z-50">
    <img src="di_logo.png" alt="Logo" class="w-24 h-24 rounded-full mb-4 animate-pulse">
    <p class="text-white text-lg">á€áŸ†á–á»á„á•áŸ’á‘á»á€á”áŸ’ášá–áŸá“áŸ’á’...</p>
  </div>

  <div class="container w-full max-w-md p-6 bg-white rounded-2xl shadow-2xl relative">
    <h1 class="text-center text-2xl font-bold mb-2">á”áŸ’ášá–áŸá“áŸ’á’áŸáŸ’á€áŸá“á˜á»ááŒá¸á‡á¸áá›</h1>
    <p id="subtitle" class="text-center text-gray-500 mb-4">áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸá¢ááŸ’áá›áŸáášá”áŸáŸ‹á¢áŸ’á“á€</p>

    <!-- Selection -->
    <div id="selection-area" class="mb-5">
      <select id="student-select"></select>
    </div>

    <!-- Camera -->
    <div id="camera-section" class="hidden flex flex-col items-center space-y-3">
      <div id="video-wrapper" class="video-container w-64 h-64 bg-gray-200 mb-3">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>
      <canvas id="capture-canvas" class="hidden"></canvas>
      <img id="photo-preview" class="hidden w-64 h-64 rounded-full border-4 border-green-500 object-cover">
      <p id="face-status" class="text-center text-sm h-5 font-semibold"></p>
      <div class="flex flex-col w-full space-y-2">
        <button id="upload-btn" class="hidden w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition">
          á”á‰áŸ’á‡á¼á“ášá¼á”á—á¶á–
        </button>
        <button id="retake-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600 transition">
          ááá˜áŸ’áá„á‘áŸ€á
        </button>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx9mHDxed9qEJZl7JP0KifDmQKcZqGStL1zqLBJpJ-qYD6pqywHCkvhGfaoXXbpQgKq/exec';
    const studentSelect = document.getElementById('student-select');
    const video = document.getElementById('video');
    const captureCanvas = document.getElementById('capture-canvas');
    const photoPreview = document.getElementById('photo-preview');
    const uploadBtn = document.getElementById('upload-btn');
    const retakeBtn = document.getElementById('retake-btn');
    const cameraSection = document.getElementById('camera-section');
    const videoWrapper = document.getElementById('video-wrapper');
    const faceStatus = document.getElementById('face-status');
    const subtitle = document.getElementById('subtitle');
    const loadingState = document.getElementById('loading-state');

    let studentsData = [], currentStream, faceApiInterval, stableFrames = 0, choicesInstance;

    // ğŸ§  Initialize dropdown
    function initChoices() {
      choicesInstance = new Choices(studentSelect, {
        searchEnabled: true,
        placeholder: true,
        placeholderValue: 'áŸá¼á˜á‡áŸ’ášá¾áŸ ID á¬áˆáŸ’á˜áŸ„áŸ‡...',
        noResultsText: 'ášá€á˜á·á“áƒá¾á‰á‘á·á“áŸ’á“á“áŸá™',
        itemSelectText: '',
      });
    }

    async function loadModels() {
      const MODEL_URL = './weights';
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
        faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
        faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
      ]);
    }

    async function fetchStudents() {
      try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        studentsData = data.slice(1);
        const options = studentsData.map(s => ({ value: s[0], label: `${s[0]} - ${s[1]}` }));
        choicesInstance.setChoices(options, 'value', 'label', false);
      } catch (e) {
        alert('á˜á·á“á¢á¶á…á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™áŸá·áŸáŸ’áŸá”á¶á“á‘áŸ');
      }
    }

    async function startCamera() {
      subtitle.textContent = "á€áŸ†á–á»á„á”á¾á€á€á¶á˜áŸášáŸ‰á¶...";
      cameraSection.classList.remove('hidden');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 480 } });
        currentStream = stream;
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          subtitle.textContent = "áŸá¼á˜á…á¶áŸ†á”áŸ’ášá–áŸá“áŸ’á’áœá·á—á¶á‚á˜á»á...";
          detectFace();
        };
      } catch (err) {
        alert('áŸá¼á˜á¢á“á»á‰áŸ’á‰á¶áá±áŸ’á™á”áŸ’ášá¾á€á¶á˜áŸášáŸ‰á¶');
      }
    }

    async function detectFace() {
      const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
      clearInterval(faceApiInterval);
      faceApiInterval = setInterval(async () => {
        const result = await faceapi.detectSingleFace(video, options).withFaceExpressions();
        if (result && result.detection.score > 0.8) {
          stableFrames++;
          faceStatus.textContent = `á€áŸ†á–á»á„á…á¶á”áŸ‹á•áŸ’á‘áŸƒá˜á»á... (${stableFrames}/4)`;
          faceStatus.classList.replace('text-red-500', 'text-green-500');
          videoWrapper.classList.add('ready');
          if (stableFrames >= 4) captureFace();
        } else {
          stableFrames = 0;
          faceStatus.textContent = "áŸá¼á˜áŠá¶á€áŸ‹á˜á»áá…áŸ†á€ááŸ’áá¶á›á€á¶á˜áŸášáŸ‰á¶";
          faceStatus.classList.add('text-red-500');
          videoWrapper.classList.remove('ready');
        }
      }, 350);
    }

    function captureFace() {
      const ctx = captureCanvas.getContext('2d');
      const size = 512;
      captureCanvas.width = size;
      captureCanvas.height = size;
      ctx.translate(size, 0); ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, size, size);
      photoPreview.src = captureCanvas.toDataURL('image/jpeg', 0.9);
      stopCamera();
      videoWrapper.classList.add('hidden');
      photoPreview.classList.remove('hidden');
      uploadBtn.classList.remove('hidden');
      retakeBtn.classList.remove('hidden');
      faceStatus.classList.add('hidden');
      subtitle.textContent = "áŸá¼á˜á”á‰áŸ’á‡á¶á€áŸ‹ášá¼á”á—á¶á–ášá”áŸáŸ‹á¢áŸ’á“á€";
    }

    function stopCamera() {
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      clearInterval(faceApiInterval);
    }

    uploadBtn.onclick = async () => {
      const id = choicesInstance.getValue(true);
      const s = studentsData.find(x => x[0] == id);
      const imageData = captureCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
      uploadBtn.textContent = "á€áŸ†á–á»á„á•áŸ’á‰á¾...";
      uploadBtn.disabled = true;
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ id: s[0], name: s[1], class: s[2], imageData }),
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const r = await res.json();
        if (r.status === 'success') {
          alert("âœ… á”á‰áŸ’á‡á¼á“á‡áŸ„á‚á‡áŸá™!");
          location.reload();
        } else throw new Error(r.message);
      } catch (e) {
        alert("á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá”á‰áŸ’á‡á¼á“ášá¼á”á—á¶á–áŸ”");
        uploadBtn.disabled = false;
        uploadBtn.textContent = "á”á‰áŸ’á‡á¼á“ášá¼á”á—á¶á–";
      }
    };

    retakeBtn.onclick = async () => {
      photoPreview.classList.add('hidden');
      uploadBtn.classList.add('hidden');
      retakeBtn.classList.add('hidden');
      videoWrapper.classList.remove('hidden');
      faceStatus.classList.remove('hidden');
      stableFrames = 0;
      await startCamera();
    };

    // â¸ Pause camera when page is hidden (save battery)
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopCamera();
    });

    window.onload = async () => {
      initChoices();
      await loadModels();
      await fetchStudents();
      loadingState.style.display = 'none';
      studentSelect.addEventListener('change', async e => {
        if (e.detail.value) await startCamera();
      });
    };
  </script>
</body>
</html>


